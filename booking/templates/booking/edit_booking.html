{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-white">Edit Booking</h2>

  <div class="card bg-dark" style="background-color: rgba(0,0,0,0.6);">
    <div class="card-body">
      <h5 class="card-title text-white">Current: {{ booking.showtime.film.title }} — {{ booking.showtime.date|date:"D j M Y" }} at {{ booking.showtime.time|time:"H:i" }}</h5>
      <p class="text-white small">Seats: {{ booking.seat_numbers }}</p>

      <form method="post" id="editBookingForm">
        {% csrf_token %}
        <div class="row mb-3">
          <div class="col-md-6 mb-2">
            <label for="film_select" class="form-label text-white">Filter by Film</label>
            <select id="film_select" class="form-select">
              <option value="">All films</option>
              {% for f in films %}
                <option value="{{ f.id }}" {% if booking.showtime.film.id == f.id %}selected{% endif %}>{{ f.title }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label for="showtime" class="form-label text-white">Choose a different showtime (this will clear existing seats)</label>
            <select name="showtime_id" id="showtime" class="form-select">
              <!-- options filled by JS -->
            </select>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary" id="openSeatModalBtn">Update Booking</button>
          <a href="{% url 'manage_bookings' %}" class="btn btn-outline-light">Cancel</a>
        </div>
      </form>

      <p class="mt-3 text-muted">Note: Changing the showtime will clear the seats associated with this booking. After updating you'll be asked to re-select seats.</p>
    </div>
  </div>
</div>

<script>
  (function(){
    var showtimes = {{ showtimes_json|safe }} || [];
    var filmSelect = document.getElementById('film_select');
    var showtimeSelect = document.getElementById('showtime');
    var currentShowtimeId = {{ booking.showtime.id }};

    function renderOptions(filterFilmId){
      showtimeSelect.innerHTML = '';
      var list = showtimes.filter(function(s){
        return !filterFilmId || String(s.film_id) === String(filterFilmId);
      });
      list.forEach(function(s){
        var opt = document.createElement('option');
        opt.value = s.id;
        opt.text = s.film_title + ' — ' + s.date + ' ' + s.time + ' (' + s.screen + ') — £' + s.price;
        if(String(s.id) === String(currentShowtimeId)) opt.selected = true;
        showtimeSelect.appendChild(opt);
      });
    }

    // initial render: filter to current film so user's selection remains
    renderOptions({{ booking.showtime.film.id }});

    filmSelect.addEventListener('change', function(){
      renderOptions(this.value);
    });
  })();
</script>

<!-- Seat reselect modal -->
<div class="modal fade" id="reselectSeatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Reselect seats</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="reselectModalBody">
        <!-- Seat map partial will be loaded here -->
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  var form = document.getElementById('editBookingForm');
  var modalEl = document.getElementById('reselectSeatModal');
  var bootstrapModal = null;
  if(window.bootstrap && modalEl){
    // Move modal element to document.body to avoid stacking/context issues
    // where ancestor stacking contexts or overlays sit above the modal.
    try { document.body.appendChild(modalEl); } catch(e) { /* ignore */ }
    bootstrapModal = new bootstrap.Modal(modalEl);
  }

  form.addEventListener('submit', function(e){
    e.preventDefault();
    var showtimeId = document.getElementById('showtime').value;
    if(!showtimeId){ alert('Please select a showtime'); return; }

    // Load seat map partial
    var url = '/booking/select-seats/' + showtimeId + '/?modal=1&booking_id={{ booking.booking_id }}';
    fetch(url, { credentials: 'same-origin' })
      .then(function(r){ return r.text(); })
      .then(function(html){
        var body = document.getElementById('reselectModalBody');
        // Use DOMParser so we can extract and execute scripts from the returned HTML.
        var parser = new DOMParser();
        var doc = parser.parseFromString(html, 'text/html');

        // Clear and append non-script nodes
        body.innerHTML = '';
        Array.from(doc.body.childNodes).forEach(function(node){
          if(node.tagName && node.tagName.toLowerCase() === 'script') return; // skip scripts for now
          body.appendChild(document.importNode(node, true));
        });

        // Execute scripts by creating new script elements
        var scripts = doc.querySelectorAll('script');
        scripts.forEach(function(s){
          var newScript = document.createElement('script');
          // Copy attributes (e.g., type)
          Array.from(s.attributes || []).forEach(function(attr){ newScript.setAttribute(attr.name, attr.value); });
          newScript.text = s.textContent;
          document.body.appendChild(newScript);
          // remove after execution to keep DOM clean
          document.body.removeChild(newScript);
        });

        // Initialize modal seat logic if provided
        if(typeof window.initModalSeatSelection === 'function'){
          try { window.initModalSeatSelection(); } catch(e) { console.error('initModalSeatSelection', e); }
        }
        if(bootstrapModal) bootstrapModal.show();
      })
      .catch(function(err){ console.error(err); alert('Could not load seat map'); });
  });
});
</script>

{% endblock %}
