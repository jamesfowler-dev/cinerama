{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container py-4">
  <h2 class="mb-4 text-white">Edit Booking</h2>

  <div class="card bg-dark" style="background-color: rgba(0,0,0,0.6);">
    <div class="card-body">
      <h5 class="card-title text-white">Current: {{ booking.showtime.film.title }} â€” {{ booking.showtime.date|date:"D j M Y" }} at {{ booking.showtime.time|time:"H:i" }}</h5>
      <p class="text-white small">Seats: {{ booking.seat_numbers }}</p>

  <form method="post" id="editBookingForm" data-booking-id='{{ booking.booking_id }}' data-current-showtime='{{ booking.showtime.id }}'>
        {% csrf_token %}
        <div class="row mb-3">
          <div class="col-md-6 mb-2">
            <label for="film_select" class="form-label text-white">Filter by Film</label>
            <select id="film_select" class="form-select">
              <option value="">All films</option>
              {% for f in films %}
                <option value="{{ f.id }}" {% if booking.showtime.film.id == f.id %}selected{% endif %}>{{ f.title }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-6">
            <label for="showtime" class="form-label text-white">Choose a different showtime (this will clear existing seats)</label>
            <select name="showtime_id" id="showtime" class="form-select">
              <!-- options filled by JS -->
            </select>
          </div>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-primary" id="openSeatModalBtn">Update Booking</button>
          <a href="{% url 'manage_bookings' %}" class="btn btn-outline-light">Cancel</a>
        </div>
      </form>

      <p class="mt-3 text-muted">Note: Changing the showtime will clear the seats associated with this booking. After updating you'll be asked to re-select seats.</p>
    </div>
  </div>
</div>

    {# Embed showtimes JSON in a safe application/json block to avoid attribute-escaping edge cases. #}
    <script id="showtimes-data" type="application/json">{{ showtimes_json|safe }}</script>

    {# Showtime rendering and modal handling are centralized in static/js/script.js #}

<!-- Seat reselect modal -->
<div class="modal fade" id="reselectSeatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content bg-dark text-white">
      <div class="modal-header">
        <h5 class="modal-title">Reselect seats</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="reselectModalBody">
        <!-- Seat map partial will be loaded here -->
      </div>
    </div>
  </div>
</div>

{# Modal fetch & initialization handled centrally in static/js/script.js #}

{% endblock %}
