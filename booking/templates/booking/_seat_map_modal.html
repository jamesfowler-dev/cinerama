{% load static %}

<div class="seat-selection-modal" data-showtime-price="{{ showtime.price }}" data-showtime-id="{{ showtime.id }}" data-booking-id="{{ booking.booking_id|default:'' }}">
    <div class="row">
        <div class="col-lg-8">
            <div class="seat-selection-container">
                <h5 class="text-center mb-3 text-white">Select seats for {{ film.title }} — {{ showtime.date|date:"D j M Y" }} at {{ showtime.time|time:"H:i" }}</h5>

                <div class="screen-indicator text-center mb-3">
                    <div class="screen-line"></div>
                    <p class="mt-2 text-muted">SCREEN</p>
                </div>

                <div class="seat-map" id="modalSeatMap">
                    {% regroup seats by row as seat_rows %}
                    {% for row_group in seat_rows %}
                    <div class="seat-row d-flex justify-content-center align-items-center mb-2">
                        <span class="row-label me-3 fw-bold">{{ row_group.grouper }}</span>
                        <div class="seats d-flex">
                            {% for seat in row_group.list %}
                            <button type="button"
                                    class="seat {% if seat.id in booked_seats %}booked{% else %}available{% endif %}"
                                    data-seat-id="{{ seat.id }}"
                                    data-seat-number="{{ seat }}"
                                    {% if seat.id in booked_seats %}disabled{% endif %}>
                                {{ seat.number }}
                            </button>
                            {% endfor %}
                        </div>
                        <span class="row-label ms-3 fw-bold">{{ row_group.grouper }}</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card bg-dark text-white p-3">
                <h6>Selected Seats</h6>
                <ul id="modalSelectedSeatsList" class="list-unstyled mb-3 text-white"><li class="text-muted">No seats selected</li></ul>
                <div class="d-flex justify-content-between mb-2">
                    <span>Seat Price:</span>
                    <span>£{{ showtime.price }}</span>
                </div>
                <div class="d-flex justify-content-between mb-2">
                    <span>Quantity:</span>
                    <span id="modalSeatQuantity">0</span>
                </div>
                <div class="d-flex justify-content-between mb-3 fw-bold">
                    <span>Total:</span>
                    <span id="modalTotalPrice">£0.00</span>
                </div>

                <div class="d-grid">
                    <button id="modalConfirmSeats" class="btn btn-success">Confirm seats and update booking</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Minimal seat styles (relies on global styles where available) */
.seat { width:30px; height:30px; margin:2px; border-radius:6px; }
.seat.available { background:#e8f5e8; border:2px solid #28a745; color:#28a745 }
.seat.selected { background:var(--cinema-red); color:#fff }
.seat.booked { background:#dc3545; color:#fff; opacity:0.6 }
.screen-line { width:60%; height:4px; background:linear-gradient(135deg,var(--cinema-red) 0%,var(--cinema-gold) 100%); margin:0 auto; border-radius:2px }
</style>

{# Seat map initialization is handled by centralized JS (static/js/script.js).
   The edit page will call bookingSeatSelector.init('#modalSeatMap', { modal: true, bookingId: '...' })
   after inserting this partial into the modal body. #}

<!-- Modal fallback: if the central bookingSeatSelector isn't available (script.js failed to load),
     attach a small local handler so the modal seat map still works. This keeps functionality
     available while you debug the main script. -->
<script>
document.addEventListener('DOMContentLoaded', function(){
    // If the modal is loaded into the page later via fetch, this will still run when inserted.
    try {
        if(window.bookingSeatSelector && typeof window.bookingSeatSelector.init === 'function') return;

        var modalRoot = document.querySelector('.seat-selection-modal');
        if(!modalRoot) return;

        var seatButtons = modalRoot.querySelectorAll('.seat.available');
        var selected = [];
        var selectedList = modalRoot.querySelector('#modalSelectedSeatsList');
        var qtyEl = modalRoot.querySelector('#modalSeatQuantity');
        var totalEl = modalRoot.querySelector('#modalTotalPrice');
        var confirmBtn = modalRoot.querySelector('#modalConfirmSeats');
        var price = parseFloat(modalRoot.dataset.showtimePrice || 0) || 0;

        function refresh(){
            if(selectedList) selectedList.innerHTML = selected.length ? selected.map(function(s){ return '<li>'+s.number+' — £'+price+'</li>'; }).join('') : '<li class="text-muted">No seats selected</li>';
            if(qtyEl) qtyEl.textContent = selected.length;
            if(totalEl) totalEl.textContent = '£' + (selected.length * price).toFixed(2);
            if(confirmBtn) confirmBtn.disabled = selected.length === 0;
        }

        seatButtons.forEach(function(btn){
            btn.addEventListener('click', function(){
                var id = btn.getAttribute('data-seat-id');
                var number = btn.getAttribute('data-seat-number');
                var idx = selected.findIndex(function(s){ return s.id === id; });
                if(idx !== -1){ selected.splice(idx,1); btn.classList.remove('selected'); }
                else { selected.push({id:id, number:number}); btn.classList.add('selected'); }
                refresh();
            });
        });

        refresh();
    } catch(e){ console.error('modal fallback error', e); }
});
</script>
